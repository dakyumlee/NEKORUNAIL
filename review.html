<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¦¬ë·° - NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { db, storage } from './firebase.js';
    import {
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      limit,
      startAfter
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    let selectedRating = 0;

    document.addEventListener("DOMContentLoaded", function() {
      console.log('DOM ë¡œë“œ ì™„ë£Œ');
      
      const starRating = document.getElementById('star-rating');
      if (starRating) {
        starRating.innerHTML = `
          <span class="star" onclick="selectRating(1)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">â­</span>
          <span class="star" onclick="selectRating(2)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">â­</span>
          <span class="star" onclick="selectRating(3)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">â­</span>
          <span class="star" onclick="selectRating(4)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">â­</span>
          <span class="star" onclick="selectRating(5)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">â­</span>
        `;
        console.log('ë³„ì  ìƒì„± ì™„ë£Œ');
      }

      const reviewForm = document.getElementById("review-form");
      if (reviewForm) {
        reviewForm.addEventListener("submit", async function(e) {
          e.preventDefault();
          await handleReviewSubmit();
        });
      }

      const imageInput = document.getElementById("review-image");
      const imagePreview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      const removeImageBtn = document.getElementById("remove-image");
      
      if (imageInput) {
        imageInput.addEventListener("change", function(e) {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) {
              alert("íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
              imageInput.value = '';
              return;
            }

            if (!file.type.startsWith('image/')) {
              alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
              imageInput.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
              if (previewImg) previewImg.src = e.target.result;
              if (imagePreview) imagePreview.style.display = 'block';
              const uploadArea = document.querySelector('.image-upload-area');
              if (uploadArea) uploadArea.style.display = 'none';
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (removeImageBtn) {
        removeImageBtn.addEventListener("click", function() {
          imageInput.value = '';
          if (imagePreview) imagePreview.style.display = 'none';
          const uploadArea = document.querySelector('.image-upload-area');
          if (uploadArea) uploadArea.style.display = 'block';
        });
      }

      loadReviews();
    });

    window.selectRating = function(rating) {
      selectedRating = rating;
      document.getElementById('rating').value = rating;
      
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.opacity = '1';
        } else {
          star.style.opacity = '0.3';
        }
      });
      
      const texts = [
        'ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”',
        'â­ ë³„ë¡œì˜ˆìš”',
        'â­â­ ê·¸ì € ê·¸ë˜ìš”',
        'â­â­â­ ë³´í†µì´ì—ìš”',
        'â­â­â­â­ ì¢‹ì•„ìš”',
        'â­â­â­â­â­ ìµœê³ ì˜ˆìš”!'
      ];
      
      document.querySelector('.rating-text').textContent = texts[rating];
      console.log('ë³„ì  ì„ íƒë¨:', rating);
    };

    async function handleReviewSubmit() {
      const name = document.getElementById("reviewer").value.trim();
      const content = document.getElementById("review-content").value.trim();
      const rating = selectedRating;
      const imageInput = document.getElementById("review-image");
      const imageFile = imageInput ? imageInput.files[0] : null;
      
      if (!name || !content) {
        alert("ì´ë¦„ê³¼ í›„ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!rating || rating < 1 || rating > 5) {
        alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        let imageUrl = null;

        if (imageFile) {
          console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘');
          const imageRef = ref(storage, `reviews/${Date.now()}_${imageFile.name}`);
          await uploadBytes(imageRef, imageFile);
          imageUrl = await getDownloadURL(imageRef);
          console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:', imageUrl);
        }

        await addDoc(collection(db, "reviews"), {
          name,
          content,
          rating,
          imageUrl,
          createdAt: serverTimestamp()
        });
        
        alert("í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ’–");

        document.getElementById("review-form").reset();
        selectedRating = 0;
        document.getElementById('rating').value = '';
        
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => star.style.opacity = '0.3');
        document.querySelector('.rating-text').textContent = 'ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”';

        const imagePreview = document.getElementById("image-preview");
        if (imagePreview) imagePreview.style.display = 'none';
        const uploadArea = document.querySelector('.image-upload-area');
        if (uploadArea) uploadArea.style.display = 'block';
        
        loadReviews();

      } catch (error) {
        console.error("í›„ê¸° ë“±ë¡ ì‹¤íŒ¨:", error);
        alert("í›„ê¸° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function loadReviews() {
      try {
        const reviewsContainer = document.getElementById("reviews-container");
        if (!reviewsContainer) return;
        
        const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        reviewsContainer.innerHTML = '';
        
        if (snapshot.empty) {
          reviewsContainer.innerHTML = `
            <div class="no-reviews">
              <p>ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              <p>ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”! âœ¨</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(function(doc) {
          const data = doc.data();
          const reviewBox = document.createElement("div");
          reviewBox.className = "review-box";
          
          const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
          const dateString = createdAt.toLocaleDateString('ko-KR');
          
          const rating = data.rating || 5;
          const starsDisplay = 'â­'.repeat(rating) + 'â˜†'.repeat(5 - rating);
          
          reviewBox.innerHTML = `
            <div class="review-header">
              <strong class="review-author">ğŸ‘¤ ${data.name}</strong>
              <span class="review-date">ğŸ“… ${dateString}</span>
            </div>
            <div class="review-rating">${starsDisplay}</div>
            <div class="review-content">${data.content}</div>
          `;
          
          reviewsContainer.appendChild(reviewBox);
        });
        
      } catch (error) {
        console.error("í›„ê¸° ë¡œë“œ ì‹¤íŒ¨:", error);
      }
    }
  </script>
</head>
<body>
  <header class="hero">
    <nav>
        <ul>
          <li><a href="index.html">í™ˆ</a></li>
          <li><a href="gallery.html">ê°¤ëŸ¬ë¦¬</a></li>
          <li><a href="booking.html">ì˜ˆì•½</a></li>
          <li><a href="review.html">ë¦¬ë·° ë‚¨ê¸°ê¸°</a></li>
          <li><a href="come.html">ì°¾ì•„ì˜¤ì‹œëŠ” ê¸¸</a></li>
        </ul>
      </nav>
      <br><br>
    <h1>ë¦¬ë·°</h1>
    <p>ê³ ê°ë‹˜ì˜ ì†Œì¤‘í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”</p>
  </header>

  <section class="review-form-section">
    <div class="form-container">
      <h3>í›„ê¸° ì‘ì„±í•˜ê¸°</h3>
      <form id="review-form">
        <div class="form-group">
          <label for="reviewer">ì´ë¦„</label>
          <input type="text" id="reviewer" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required style="font-family: 'MaruBuri';"/>
        </div>
        
        <div class="form-group">
          <label for="rating">ë³„ì </label>
          <div class="star-rating" id="star-rating" style="display: flex; gap: 0.3rem; margin: 1rem 0; justify-content: center;">
            
          </div>
          <input type="hidden" id="rating" name="rating" required />
          <p class="rating-text">ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”</p>
        </div>
        
        <div class="form-group">
          <label for="review-content">í›„ê¸° ë‚´ìš©</label>
          <textarea id="review-content" placeholder="ë„¤ì¼ ì„œë¹„ìŠ¤ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” ğŸ’–" required style="font-family: 'MaruBuri'; height: 120px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="review-image">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒì‚¬í•­)</label>
          <div class="image-upload-area">
            <input type="file" id="review-image" accept="image/*" />
            <div class="upload-placeholder">
              <div class="upload-icon">ğŸ“·</div>
              <p>ë„¤ì¼ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
              <span class="upload-hint">JPG, PNG, GIF í˜•ì‹ (ìµœëŒ€ 5MB)</span>
            </div>
          </div>
          <div id="image-preview" style="display: none;">
            <img id="preview-img" alt="ë¯¸ë¦¬ë³´ê¸°" />
            <button type="button" id="remove-image">ì‚¬ì§„ ì œê±°</button>
          </div>
        </div>
        
        <button type="submit" id="submit-btn">
          í›„ê¸° ë“±ë¡í•˜ê¸°
        </button>
      </form>
    </div>
  </section>

  <section class="reviews-display-section">
    <h3>ê³ ê°ë‹˜ë“¤ì˜ í›„ê¸°</h3>
    <div id="reviews-container"></div>
  </section>

  <footer>
    <p>NEKORUNAIL âœ Instagram @NEKORUnail âœ 2025</p>
  </footer>
</body>
</html>