<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>리뷰 - NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { db, storage } from './firebase.js';
    import {
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      limit,
      startAfter
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    let selectedRating = 0;

    document.addEventListener("DOMContentLoaded", function() {
      console.log('DOM 로드 완료');
      
      const starRating = document.getElementById('star-rating');
      if (starRating) {
        starRating.innerHTML = `
          <span class="star" onclick="selectRating(1)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">⭐</span>
          <span class="star" onclick="selectRating(2)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">⭐</span>
          <span class="star" onclick="selectRating(3)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">⭐</span>
          <span class="star" onclick="selectRating(4)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">⭐</span>
          <span class="star" onclick="selectRating(5)" style="font-size: 2rem; cursor: pointer; opacity: 0.3;">⭐</span>
        `;
        console.log('별점 생성 완료');
      }

      const reviewForm = document.getElementById("review-form");
      if (reviewForm) {
        reviewForm.addEventListener("submit", async function(e) {
          e.preventDefault();
          await handleReviewSubmit();
        });
      }

      const imageInput = document.getElementById("review-image");
      const imagePreview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      const removeImageBtn = document.getElementById("remove-image");
      
      if (imageInput) {
        imageInput.addEventListener("change", function(e) {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) {
              alert("파일 크기는 5MB 이하여야 합니다.");
              imageInput.value = '';
              return;
            }

            if (!file.type.startsWith('image/')) {
              alert("이미지 파일만 업로드 가능합니다.");
              imageInput.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
              if (previewImg) previewImg.src = e.target.result;
              if (imagePreview) imagePreview.style.display = 'block';
              const uploadArea = document.querySelector('.image-upload-area');
              if (uploadArea) uploadArea.style.display = 'none';
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (removeImageBtn) {
        removeImageBtn.addEventListener("click", function() {
          imageInput.value = '';
          if (imagePreview) imagePreview.style.display = 'none';
          const uploadArea = document.querySelector('.image-upload-area');
          if (uploadArea) uploadArea.style.display = 'block';
        });
      }

      loadReviews();
    });

    window.selectRating = function(rating) {
      selectedRating = rating;
      document.getElementById('rating').value = rating;
      
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.opacity = '1';
        } else {
          star.style.opacity = '0.3';
        }
      });
      
      const texts = [
        '별을 클릭하여 평점을 매겨주세요',
        '⭐ 별로예요',
        '⭐⭐ 그저 그래요',
        '⭐⭐⭐ 보통이에요',
        '⭐⭐⭐⭐ 좋아요',
        '⭐⭐⭐⭐⭐ 최고예요!'
      ];
      
      document.querySelector('.rating-text').textContent = texts[rating];
      console.log('별점 선택됨:', rating);
    };

    async function handleReviewSubmit() {
      const name = document.getElementById("reviewer").value.trim();
      const content = document.getElementById("review-content").value.trim();
      const rating = selectedRating;
      const imageInput = document.getElementById("review-image");
      const imageFile = imageInput ? imageInput.files[0] : null;
      
      if (!name || !content) {
        alert("이름과 후기 내용을 입력해주세요.");
        return;
      }

      if (!rating || rating < 1 || rating > 5) {
        alert("별점을 선택해주세요.");
        return;
      }

      try {
        let imageUrl = null;

        if (imageFile) {
          console.log('이미지 업로드 시작');
          const imageRef = ref(storage, `reviews/${Date.now()}_${imageFile.name}`);
          await uploadBytes(imageRef, imageFile);
          imageUrl = await getDownloadURL(imageRef);
          console.log('이미지 업로드 완료:', imageUrl);
        }

        await addDoc(collection(db, "reviews"), {
          name,
          content,
          rating,
          imageUrl,
          createdAt: serverTimestamp()
        });
        
        alert("후기가 등록되었습니다! 감사합니다 💖");

        document.getElementById("review-form").reset();
        selectedRating = 0;
        document.getElementById('rating').value = '';
        
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => star.style.opacity = '0.3');
        document.querySelector('.rating-text').textContent = '별을 클릭하여 평점을 매겨주세요';

        const imagePreview = document.getElementById("image-preview");
        if (imagePreview) imagePreview.style.display = 'none';
        const uploadArea = document.querySelector('.image-upload-area');
        if (uploadArea) uploadArea.style.display = 'block';
        
        loadReviews();

      } catch (error) {
        console.error("후기 등록 실패:", error);
        alert("후기 등록 중 오류가 발생했습니다.");
      }
    }

    async function loadReviews() {
      try {
        const reviewsContainer = document.getElementById("reviews-container");
        if (!reviewsContainer) return;
        
        const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        reviewsContainer.innerHTML = '';
        
        if (snapshot.empty) {
          reviewsContainer.innerHTML = `
            <div class="no-reviews">
              <p>아직 등록된 후기가 없습니다.</p>
              <p>첫 번째 후기를 남겨보세요! ✨</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(function(doc) {
          const data = doc.data();
          const reviewBox = document.createElement("div");
          reviewBox.className = "review-box";
          
          const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
          const dateString = createdAt.toLocaleDateString('ko-KR');
          
          const rating = data.rating || 5;
          const starsDisplay = '⭐'.repeat(rating) + '☆'.repeat(5 - rating);
          
          reviewBox.innerHTML = `
            <div class="review-header">
              <strong class="review-author">👤 ${data.name}</strong>
              <span class="review-date">📅 ${dateString}</span>
            </div>
            <div class="review-rating">${starsDisplay}</div>
            <div class="review-content">${data.content}</div>
          `;
          
          reviewsContainer.appendChild(reviewBox);
        });
        
      } catch (error) {
        console.error("후기 로드 실패:", error);
      }
    }
  </script>
</head>
<body>
  <header class="hero">
    <nav>
        <ul>
          <li><a href="index.html">홈</a></li>
          <li><a href="gallery.html">갤러리</a></li>
          <li><a href="booking.html">예약</a></li>
          <li><a href="review.html">리뷰 남기기</a></li>
          <li><a href="come.html">찾아오시는 길</a></li>
        </ul>
      </nav>
      <br><br>
    <h1>리뷰</h1>
    <p>고객님의 소중한 후기를 남겨주세요</p>
  </header>

  <section class="review-form-section">
    <div class="form-container">
      <h3>후기 작성하기</h3>
      <form id="review-form">
        <div class="form-group">
          <label for="reviewer">이름</label>
          <input type="text" id="reviewer" placeholder="이름을 입력해주세요" required style="font-family: 'MaruBuri';"/>
        </div>
        
        <div class="form-group">
          <label for="rating">별점</label>
          <div class="star-rating" id="star-rating" style="display: flex; gap: 0.3rem; margin: 1rem 0; justify-content: center;">
            
          </div>
          <input type="hidden" id="rating" name="rating" required />
          <p class="rating-text">별을 클릭하여 평점을 매겨주세요</p>
        </div>
        
        <div class="form-group">
          <label for="review-content">후기 내용</label>
          <textarea id="review-content" placeholder="네일 서비스는 어떠셨나요? 솔직한 후기를 남겨주세요 💖" required style="font-family: 'MaruBuri'; height: 120px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="review-image">사진 첨부 (선택사항)</label>
          <div class="image-upload-area">
            <input type="file" id="review-image" accept="image/*" />
            <div class="upload-placeholder">
              <div class="upload-icon">📷</div>
              <p>네일 사진을 업로드해주세요</p>
              <span class="upload-hint">JPG, PNG, GIF 형식 (최대 5MB)</span>
            </div>
          </div>
          <div id="image-preview" style="display: none;">
            <img id="preview-img" alt="미리보기" />
            <button type="button" id="remove-image">사진 제거</button>
          </div>
        </div>
        
        <button type="submit" id="submit-btn">
          후기 등록하기
        </button>
      </form>
    </div>
  </section>

  <section class="reviews-display-section">
    <h3>고객님들의 후기</h3>
    <div id="reviews-container"></div>
  </section>

  <footer>
    <p>NEKORUNAIL ⎜ Instagram @NEKORUnail ⎜ 2025</p>
  </footer>
</body>
</html>