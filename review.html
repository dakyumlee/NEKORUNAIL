<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>리뷰 - NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    // Firebase 직접 연결 테스트
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGvgFrFl1DWpkgqbwRo-TUwJa6quvohmA",
      authDomain: "nekorunail.firebaseapp.com",
      projectId: "nekorunail",
      storageBucket: "nekorunail.appspot.com",
      messagingSenderId: "571846382457",
      appId: "1:571846382457:web:6c0f66ca63163473fd15a8",
      measurementId: "G-MW8CBHGSLG"
    };

    let selectedRating = 0;
    let db, storage;

    document.addEventListener("DOMContentLoaded", async function() {
      console.log('페이지 로드 시작');
      
      try {
        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        storage = getStorage(app);
        console.log('Firebase 초기화 성공!');
        
        // 별점 초기화
        initStars();
        
        // 이벤트 리스너 설정
        setupEventListeners();
        
        // 기존 리뷰 로드
        await loadReviews();
        
        console.log('모든 초기화 완료!');
        
      } catch (error) {
        console.error('초기화 실패:', error);
        alert('Firebase 연결에 실패했습니다: ' + error.message);
      }
    });

    function initStars() {
      const starRating = document.getElementById('star-rating');
      if (!starRating) {
        console.error('별점 요소를 찾을 수 없습니다');
        return;
      }
      
      starRating.innerHTML = `
        <span class="star" onclick="selectRating(1)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">⭐</span>
        <span class="star" onclick="selectRating(2)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">⭐</span>
        <span class="star" onclick="selectRating(3)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">⭐</span>
        <span class="star" onclick="selectRating(4)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">⭐</span>
        <span class="star" onclick="selectRating(5)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">⭐</span>
      `;
      console.log('별점 생성 완료');
    }

    function setupEventListeners() {
      const form = document.getElementById("review-form");
      const imageInput = document.getElementById("review-image");
      
      if (form) {
        form.addEventListener("submit", handleSubmit);
        console.log('폼 이벤트 리스너 설정 완료');
      }
      
      if (imageInput) {
        imageInput.addEventListener("change", handleImagePreview);
        console.log('이미지 이벤트 리스너 설정 완료');
      }
    }

    // 전역 함수로 별점 선택
    window.selectRating = function(rating) {
      selectedRating = rating;
      document.getElementById('rating').value = rating;
      
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.style.opacity = index < rating ? '1' : '0.3';
      });
      
      const texts = ['별을 클릭하여 평점을 매겨주세요', '⭐ 별로예요', '⭐⭐ 그저 그래요', '⭐⭐⭐ 보통이에요', '⭐⭐⭐⭐ 좋아요', '⭐⭐⭐⭐⭐ 최고예요!'];
      document.querySelector('.rating-text').textContent = texts[rating];
      console.log('별점 선택됨:', rating);
    };

    function handleImagePreview(e) {
      const file = e.target.files[0];
      const preview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert("파일 크기는 5MB 이하여야 합니다.");
          e.target.value = '';
          return;
        }

        if (!file.type.startsWith('image/')) {
          alert("이미지 파일만 업로드 가능합니다.");
          e.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          preview.style.display = 'block';
          document.querySelector('.image-upload-area').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      console.log('폼 제출 시작');
      
      const name = document.getElementById("reviewer").value.trim();
      const content = document.getElementById("review-content").value.trim();
      const rating = selectedRating;
      const imageInput = document.getElementById("review-image");
      const imageFile = imageInput ? imageInput.files[0] : null;
      
      console.log('입력값 확인:', { name, content, rating, hasImage: !!imageFile });
      
      // 유효성 검사
      if (!name) {
        alert("이름을 입력해주세요.");
        return;
      }
      
      if (!content) {
        alert("후기 내용을 입력해주세요.");
        return;
      }
      
      if (!rating || rating < 1 || rating > 5) {
        alert("별점을 선택해주세요.");
        return;
      }

      const submitBtn = document.getElementById("submit-btn");
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.textContent = "등록 중...";
        submitBtn.disabled = true;
        
        let imageUrl = null;

        // 이미지 업로드 (있는 경우)
        if (imageFile) {
          console.log('이미지 업로드 시작...');
          const imageRef = ref(storage, `reviews/${Date.now()}_${imageFile.name}`);
          await uploadBytes(imageRef, imageFile);
          imageUrl = await getDownloadURL(imageRef);
          console.log('이미지 업로드 완료:', imageUrl);
        }

        // 리뷰 데이터 저장
        console.log('Firestore에 저장 시작...');
        const docRef = await addDoc(collection(db, "reviews"), {
          name,
          content,
          rating,
          imageUrl,
          createdAt: serverTimestamp()
        });
        
        console.log('리뷰 저장 완료! 문서 ID:', docRef.id);
        alert("후기가 등록되었습니다! 감사합니다 💖");
        
        // 폼 초기화
        resetForm();
        
        // 리뷰 목록 새로고침
        await loadReviews();

      } catch (error) {
        console.error("리뷰 등록 실패:", error);
        alert("후기 등록 중 오류가 발생했습니다: " + error.message);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    function resetForm() {
      document.getElementById("review-form").reset();
      selectedRating = 0;
      document.getElementById('rating').value = '';
      
      const stars = document.querySelectorAll('.star');
      stars.forEach(star => star.style.opacity = '0.3');
      document.querySelector('.rating-text').textContent = '별을 클릭하여 평점을 매겨주세요';
      
      const preview = document.getElementById("image-preview");
      if (preview) preview.style.display = 'none';
      const uploadArea = document.querySelector('.image-upload-area');
      if (uploadArea) uploadArea.style.display = 'block';
    }

    async function loadReviews() {
      console.log('리뷰 로드 시작...');
      
      try {
        const reviewsContainer = document.getElementById("reviews-container");
        if (!reviewsContainer) {
          console.log('리뷰 컨테이너 요소를 찾을 수 없습니다');
          return;
        }
        
        const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        console.log('가져온 리뷰 수:', snapshot.size);
        
        reviewsContainer.innerHTML = '';
        
        if (snapshot.empty) {
          reviewsContainer.innerHTML = `
            <div class="no-reviews">
              <p>아직 등록된 후기가 없습니다.</p>
              <p>첫 번째 후기를 남겨보세요! ✨</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(function(doc) {
          const data = doc.data();
          const reviewBox = document.createElement("div");
          reviewBox.className = "review-box";
          
          const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
          const dateString = createdAt.toLocaleDateString('ko-KR');
          
          const rating = data.rating || 5;
          const starsDisplay = '⭐'.repeat(rating) + '☆'.repeat(5 - rating);
          
          const imageHtml = data.imageUrl ? 
            `<div style="text-align: center; margin-top: 1rem;">
               <img src="${data.imageUrl}" alt="후기 사진" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
             </div>` : '';
          
          reviewBox.innerHTML = `
            <div class="review-header">
              <strong class="review-author">👤 ${data.name}</strong>
              <span class="review-date">📅 ${dateString}</span>
            </div>
            <div class="review-rating">${starsDisplay}</div>
            <div class="review-content">${data.content}</div>
            ${imageHtml}
          `;
          
          reviewsContainer.appendChild(reviewBox);
        });
        
        console.log('리뷰 로드 완료!');
        
      } catch (error) {
        console.error("리뷰 로드 실패:", error);
        const reviewsContainer = document.getElementById("reviews-container");
        if (reviewsContainer) {
          reviewsContainer.innerHTML = `
            <div class="error-message">
              <p>후기를 불러오는데 실패했습니다.</p>
              <p>오류: ${error.message}</p>
            </div>
          `;
        }
      }
    }

    window.removeImage = function() {
      document.getElementById("review-image").value = '';
      document.getElementById("image-preview").style.display = 'none';
      document.querySelector('.image-upload-area').style.display = 'block';
    };
  </script>
</head>
<body>
  <header class="hero">
    <nav>
        <ul>
          <li><a href="index.html">홈</a></li>
          <li><a href="gallery.html">갤러리</a></li>
          <li><a href="booking.html">예약</a></li>
          <li><a href="review.html">리뷰 남기기</a></li>
          <li><a href="come.html">찾아오시는 길</a></li>
        </ul>
      </nav>
      <br><br>
    <h1>리뷰</h1>
    <p>고객님의 소중한 후기를 남겨주세요</p>
  </header>

  <section class="review-form-section">
    <div class="form-container">
      <h3>후기 작성하기</h3>
      <form id="review-form">
        <div class="form-group">
          <label for="reviewer">이름</label>
          <input type="text" id="reviewer" placeholder="이름을 입력해주세요" required style="font-family: 'MaruBuri';"/>
        </div>
        
        <div class="form-group">
          <label for="rating">별점</label>
          <div class="star-rating" id="star-rating" style="display: flex; justify-content: center; margin: 1rem 0;">
            <!-- 별점은 JavaScript로 생성됩니다 -->
          </div>
          <input type="hidden" id="rating" name="rating" required />
          <p class="rating-text" style="text-align: center;">별을 클릭하여 평점을 매겨주세요</p>
        </div>
        
        <div class="form-group">
          <label for="review-content">후기 내용</label>
          <textarea id="review-content" placeholder="네일 서비스는 어떠셨나요? 솔직한 후기를 남겨주세요 💖" required style="font-family: 'MaruBuri'; height: 120px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="review-image">사진 첨부 (선택사항)</label>
          <div class="image-upload-area">
            <input type="file" id="review-image" accept="image/*" />
            <div class="upload-placeholder">
              <div class="upload-icon">📷</div>
              <p>네일 사진을 업로드해주세요</p>
              <span class="upload-hint">JPG, PNG, GIF 형식 (최대 5MB)</span>
            </div>
          </div>
          <div id="image-preview" style="display: none; text-align: center; margin-top: 1rem;">
            <img id="preview-img" alt="미리보기" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
            <br>
            <button type="button" onclick="removeImage()" style="margin-top: 0.5rem; background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">사진 제거</button>
          </div>
        </div>
        
        <div style="text-align: center;">
          <button type="submit" id="submit-btn">
            후기 등록하기
          </button>
        </div>
      </form>
    </div>
  </section>

  <section class="reviews-display-section">
    <h3>고객님들의 후기</h3>
    <div id="reviews-container">
      <div style="text-align: center; padding: 2rem;">
        <p>후기를 불러오는 중...</p>
      </div>
    </div>
  </section>

  <footer>
    <p>NEKORUNAIL ⎜ Instagram @NEKORUnail ⎜ 2025</p>
  </footer>
</body>
</html>