<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .review-form-section { margin:0 auto; display:flex; justify-content:center; align-items:center; padding:2rem; min-height:60vh; }
    .form-container { max-width:600px; width:100%; margin:0 auto; background:white; border-radius:25px; padding:3rem; box-shadow:0 15px 35px rgba(0,0,0,0.1); text-align:center; }
    .form-container h3 { margin-bottom:2rem; font-size:1.8rem; color:#333; }
    .form-group { margin-bottom:1.5rem; }
    .form-group label { display:block; margin-bottom:0.8rem; color:#333; font-weight:600; font-size:1.1rem; }
    .form-group input, .form-group textarea { width:100%; max-width:500px; margin:0 auto; display:block; padding:1rem; border:2px solid #e1e5e9; border-radius:12px; font-size:1rem; transition:all .3s ease; box-sizing:border-box; }
    .form-group input:focus, .form-group textarea:focus { outline:none; border-color:hotpink; box-shadow:0 0 0 3px rgba(255,105,180,0.1); }
    .form-group textarea { height:120px; resize:vertical; line-height:1.6; }
    .star-rating { display:flex; gap:.3rem; margin:1rem 0; justify-content:center; }
    .star { font-size:2rem; cursor:pointer; user-select:none; opacity:.3; transition:all .2s ease; display:inline-block; padding:.2rem; }
    .star:hover { transform:scale(1.2); }
    .star.active { opacity:1; transform:scale(1.1); }
    .rating-text { margin:.5rem 0; font-weight:500; color:#333; text-align:center; }
    .image-upload-area { max-width:500px; margin:0 auto; border:3px dashed #cbd5e0; border-radius:15px; padding:2rem; text-align:center; position:relative; background:#fafbfc; cursor:pointer; transition:all .3s ease; }
    .image-upload-area:hover { border-color:hotpink; background:rgba(255,105,180,0.05); }
    .image-upload-area input[type="file"] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
    .upload-placeholder { pointer-events:none; }
    .upload-icon { font-size:2.5rem; margin-bottom:1rem; color:#a0aec0; }
    .upload-placeholder p { color:#718096; font-size:1rem; margin-bottom:.5rem; }
    .upload-hint { color:#a0aec0; font-size:.9rem; }
    #image-preview { text-align:center; margin-top:1rem; display:none; }
    #preview-img { max-width:200px; max-height:150px; border-radius:8px; }
    #remove-image { margin-top:.5rem; background:#dc2626; color:#fff; border:none; padding:.5rem 1rem; border-radius:5px; cursor:pointer; }
    .submit-btn { background:linear-gradient(135deg,#ff69b4,#ff1493); color:#fff; border:none; padding:1rem 2rem; border-radius:50px; font-size:1.1rem; font-weight:600; cursor:pointer; box-shadow:0 4px 15px rgba(255,105,180,0.4); display:inline-flex; align-items:center; gap:.5rem; transition:all .3s ease; }
    .submit-btn:hover { background:#ff69b4; transform:translateY(-2px); }
    .submit-btn:disabled { opacity:.7; cursor:not-allowed; }
    .loading-spinner { display:none; width:20px; height:20px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to{transform:rotate(360deg);} }
    .reviews-display-section { display:flex; flex-direction:column; align-items:center; padding:2rem; background:rgba(255,255,255,0.9); border-radius:20px; margin:2rem auto; max-width:1000px; }
    .reviews-controls { display:flex; justify-content:center; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
    .reviews-sort select { padding:.5rem 1rem; border:2px solid #ddd; border-radius:10px; background:#fff; font-size:.9rem; }
    #reviews-container { display:flex; flex-direction:column; align-items:center; gap:1.5rem; width:100%; max-width:700px; }
    .review-box { width:100%; max-width:700px; background:#fff; border-radius:18px; padding:2rem; box-shadow:0 8px 20px rgba(0,0,0,0.1); border-left:4px solid hotpink; transition:all .3s ease; }
    .review-box:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,0.15); }
    .review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .review-author { font-weight:700; color:hotpink; font-size:1.1rem; }
    .review-date { color:#718096; font-size:.9rem; }
    .review-rating { font-size:1.2rem; margin-bottom:1rem; color:#ffd700; }
    .review-content { color:#4a5568; line-height:1.6; margin-bottom:1.5rem; }
    .review-image-container { text-align:center; margin-top:1rem; }
    .review-image { max-width:100%; max-height:300px; border-radius:10px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:all .3s ease; }
    .review-image:hover { transform:scale(1.02); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
    .no-reviews, .error-message, .loading-reviews { width:100%; max-width:600px; text-align:center; padding:3rem 2rem; color:#718096; background:#fff; border-radius:18px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin:0 auto; }
    #load-more-btn { background:hotpink; color:#fff; border:none; padding:1rem 2rem; border-radius:50px; font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:2rem; display:none; }
    #load-more-btn:hover { background:#ff69b4; transform:translateY(-2px); }
    .image-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .modal-content { position:relative; max-width:90vw; max-height:90vh; background:#fff; border-radius:10px; overflow:hidden; }
    .modal-content img { max-width:100%; max-height:80vh; display:block; }
    .close-modal { position:absolute; top:10px; right:15px; font-size:2rem; color:#fff; cursor:pointer; background:rgba(0,0,0,0.5); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
    .modal-caption { padding:1rem; text-align:center; background:#fff; font-weight:600; color:#333; }
    @media (max-width:768px) {
      .form-container { padding:2rem; margin:1rem; }
      .star { font-size:1.8rem; }
      .reviews-display-section { padding:1rem; margin:1rem; }
      .review-box { padding:1.5rem; }
      .reviews-controls { flex-direction:column; gap:.5rem; }
    }
  </style>
</head>
<body>
  <header class="hero">
    <nav>
      <ul>
        <li><a href="index.html">홈</a></li>
        <li><a href="gallery.html">갤러리</a></li>
        <li><a href="booking.html">예약</a></li>
        <li><a href="review.html">리뷰 남기기</a></li>
        <li><a href="come.html">찾아오시는 길</a></li>
      </ul>
    </nav>
    <h1>리뷰</h1>
    <p>고객님의 소중한 후기를 남겨주세요</p>
  </header>

  <section class="review-form-section">
    <div class="form-container">
      <h3>후기 작성하기</h3>
      <form id="review-form">
        <div class="form-group">
          <label for="reviewer">이름</label>
          <input type="text" id="reviewer" placeholder="이름을 입력해주세요" required />
        </div>
        <div class="form-group">
          <label for="rating">별점</label>
          <div class="star-rating" id="star-rating"></div>
          <input type="hidden" id="rating" name="rating" required />
          <p class="rating-text">별을 클릭하여 평점을 매겨주세요</p>
        </div>
        <div class="form-group">
          <label for="review-content">후기 내용</label>
          <textarea id="review-content" placeholder="솔직한 후기를 남겨주세요 💖" required></textarea>
        </div>
        <div class="form-group">
          <label for="review-image">사진 첨부 (선택사항)</label>
          <div class="image-upload-area">
            <input type="file" id="review-image" accept="image/*" />
            <div class="upload-placeholder">
              <div class="upload-icon">📷</div>
              <p>네일 사진을 업로드해주세요</p>
              <span class="upload-hint">JPG, PNG, GIF (최대 5MB)</span>
            </div>
          </div>
          <div id="image-preview">
            <img id="preview-img" alt="미리보기" />
            <br>
            <button type="button" id="remove-image">사진 제거</button>
          </div>
        </div>
        <div style="text-align:center; margin-top:2rem;">
          <button type="submit" id="submit-btn" class="submit-btn">
            <span class="btn-text">후기 등록하기</span>
            <div class="loading-spinner"></div>
          </button>
        </div>
      </form>
    </div>
  </section>

  <section class="reviews-display-section">
    <h3>고객님들의 후기</h3>
    <div class="reviews-controls">
      <div class="reviews-sort">
        <label for="review-sort">정렬:</label>
        <select id="review-sort">
          <option value="newest">최신순</option>
          <option value="oldest">오래된순</option>
          <option value="highest">별점 높은순</option>
          <option value="lowest">별점 낮은순</option>
        </select>
      </div>
    </div>
    <div id="reviews-container">
      <div class="loading-reviews"><p>후기를 불러오는 중...</p></div>
    </div>
    <button id="load-more-btn">더 많은 후기 보기</button>
  </section>

  <footer>
    <p>NEKORUNAIL ⎜ Instagram @NEKORUnail ⎜ 2025</p>
  </footer>
  <script src="supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://erxxsytwhapgmoyepber.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyeHhzeXR3aGFwZ21veWVwYmVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzA3MDEsImV4cCI6MjA2Njk0NjcwMX0.qNQx04OHqt-kpqUE4yK9Kb1A1YWZRbGHIQ7rsW574_Q'
    
    let supabase = null;
    
    async function initSupabase() {
      if (supabase) return supabase;
      
      try {
        const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase 초기화 완료');
        return supabase;
      } catch (error) {
        console.error('❌ Supabase 초기화 실패:', error);
        throw error;
      }
    }
    
    window.loadBookings = async (date = null) => {
      try {
        const client = await initSupabase();
        let query = client.from('bookings').select('*').order('created_at', { ascending: false });
        
        if (date) {
          query = query.eq('date', date);
        }
        
        const { data, error } = await query;
        
        if (error) {
          console.error('Booking load error:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('예약 로드 실패:', error);
        return [];
      }
    };
    
    window.addBooking = async (bookingData) => {
      try {
        const client = await initSupabase();
        const { data, error } = await client
          .from('bookings')
          .insert([{
            ...bookingData,
            created_at: new Date().toISOString()
          }])
          .select();
        
        if (error) {
          console.error('Booking add error:', error);
          throw error;
        }
        return data[0];
      } catch (error) {
        console.error('예약 추가 실패:', error);
        throw error;
      }
    };
    
    window.loadGalleryImages = async () => {
      try {
        const client = await initSupabase();
        const { data, error } = await client
          .from('gallery')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Gallery load error:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('갤러리 로드 실패:', error);
        return [];
      }
    };
    
    window.addGalleryImage = async (imageData) => {
      try {
        const client = await initSupabase();
        const { data, error } = await client
          .from('gallery')
          .insert([{
            ...imageData,
            created_at: new Date().toISOString()
          }])
          .select();
        
        if (error) {
          console.error('Gallery add error:', error);
          throw error;
        }
        return data[0];
      } catch (error) {
        console.error('갤러리 추가 실패:', error);
        throw error;
      }
    };
    
    window.loadReviews = async (sortBy = 'newest', limit = null) => {
      try {
        const client = await initSupabase();
        let query = client.from('reviews').select('*');
        
        switch (sortBy) {
          case 'oldest':
            query = query.order('created_at', { ascending: true });
            break;
          case 'highest':
            query = query.order('rating', { ascending: false });
            break;
          case 'lowest':
            query = query.order('rating', { ascending: true });
            break;
          default:
            query = query.order('created_at', { ascending: false });
        }
        
        if (limit && limit > 0) {
          query = query.limit(limit);
        }
        
        console.log('리뷰 쿼리 실행 중...');
        const { data, error } = await query;
        
        if (error) {
          console.error('Reviews load error details:', error);
          return [];
        }
        
        console.log('로드된 리뷰 데이터:', data);
        return data || [];
      } catch (error) {
        console.error('리뷰 로드 실패:', error);
        return [];
      }
    };
    
    window.addReview = async (reviewData) => {
      try {
        const client = await initSupabase();
        
        // 데이터 검증 및 정리
        const cleanData = {
          name: String(reviewData.name || '익명'),
          content: String(reviewData.content || ''),
          rating: parseInt(reviewData.rating) || 5,
          image_url: reviewData.image_url || null,
          created_at: new Date().toISOString()
        };
        
        console.log('추가할 리뷰 데이터:', cleanData);
        
        const { data, error } = await client
          .from('reviews')
          .insert([cleanData])
          .select();
        
        if (error) {
          console.error('Review add error details:', error);
          throw new Error(`리뷰 추가 실패: ${error.message}`);
        }
        
        console.log('리뷰 추가 성공:', data);
        return data[0];
      } catch (error) {
        console.error('리뷰 추가 실패:', error);
        throw error;
      }
    };
    
    window.deleteRecord = async (table, id) => {
      try {
        const client = await initSupabase();
        const { error } = await client
          .from(table)
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('Delete error:', error);
          throw error;
        }
        return true;
      } catch (error) {
        console.error('삭제 실패:', error);
        throw error;
      }
    };
    
    window.updateBookingStatus = async (id, status) => {
      try {
        const client = await initSupabase();
        const { data, error } = await client
          .from('bookings')
          .update({ status })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('Status update error:', error);
          throw error;
        }
        return data[0];
      } catch (error) {
        console.error('상태 업데이트 실패:', error);
        throw error;
      }
    };
    
    window.showNotification = function(message, type = 'success') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '1rem 1.5rem',
        borderRadius: '10px',
        color: 'white',
        fontWeight: '600',
        zIndex: '10001',
        fontSize: '0.9rem',
        maxWidth: '300px',
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
        cursor: 'pointer'
      });
    
      if (type === 'success') {
        notification.style.background = '#10b981';
      } else if (type === 'error') {
        notification.style.background = '#ef4444';
      } else if (type === 'warning') {
        notification.style.background = '#f59e0b';
      } else {
        notification.style.background = '#3b82f6';
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
      
      notification.addEventListener('click', () => {
        if (notification.parentNode) {
          notification.remove();
        }
      });
    };
    
    initSupabase().catch(console.error);
    
    console.log('✅ Supabase 클라이언트 로드 완료');
  </script>
</body>
</html>