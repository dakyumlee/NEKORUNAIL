<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>리뷰 남기기 - NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="hero">
    <nav>
      <ul>
        <li><a href="index.html">홈</a></li>
        <li><a href="gallery.html">갤러리</a></li>
        <li><a href="booking.html">예약</a></li>
        <li><a href="review.html">리뷰 남기기</a></li>
        <li><a href="come.html">찾아오시는 길</a></li>
      </ul>
    </nav>
  </header>

  <section class="hero-content">
    <h1>이용 후기</h1>
    <p>시술 후기를 자유롭게 남겨주세요!</p>
  </section>

  <main class="review-container">
    <form id="review-form" enctype="multipart/form-data">
      <input type="text" id="review-name" placeholder="이름 (또는 닉네임)" required />
      <textarea id="review-content" placeholder="시술 후기 또는 만족도, 분위기 등 자유롭게 작성해주세요!" required></textarea>
      <input type="file" id="review-image" accept="image/*" />
      <button type="submit">✨ 후기 등록</button>
    </form>

    <section class="review-list" id="review-list">
      <p>로딩 중입니다...</p>
    </section>
  </main>

  <footer>
    <p>NEKORUNAIL ⎜ Instagram @nekorunail ⎜ 2025</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGvgFrFl1DWpkgqbwRo-TUwJa6quvohmA",
      authDomain: "nekorunail.firebaseapp.com",
      projectId: "nekorunail",
      storageBucket: "nekorunail.appspot.com",
      messagingSenderId: "571846382457",
      appId: "1:571846382457:web:6c0f66ca63163473fd15a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("review-form");
    const list = document.getElementById("review-list");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("review-name").value.trim();
      const content = document.getElementById("review-content").value.trim();
      const file = document.getElementById("review-image").files[0];

      try {
        let imagePath = "";
        if (file) {
          const storageRef = ref(storage, `reviews/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          imagePath = storageRef.fullPath;
        }

        await addDoc(collection(db, "reviews"), {
          name,
          content,
          imagePath,
          createdAt: serverTimestamp()
        });

        form.reset();
        loadReviews();
      } catch (err) {
        alert("리뷰 등록 실패: " + err.message);
        console.error(err);
      }
    });

    async function loadReviews() {
      list.innerHTML = "";
      try {
        const snapshot = await getDocs(collection(db, "reviews"));
        if (snapshot.empty) {
          list.innerHTML = "<p>아직 등록된 후기가 없습니다.</p>";
          return;
        }

        const frag = document.createDocumentFragment();

        for (const doc of snapshot.docs) {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "review-card";

          let imageUrl = "";
          if (data.imagePath) {
            try {
              imageUrl = await getDownloadURL(ref(storage, data.imagePath));
            } catch (err) {
              console.warn("이미지 URL 가져오기 실패:", err);
            }
          }

          card.innerHTML = `
            <h3>${data.name || "성함"}</h3>
            <p>${data.content || ""}</p>
            ${imageUrl ? `<img src="${imageUrl}" alt="리뷰 이미지" />` : ""}
          `;

          frag.appendChild(card);
        }

        list.appendChild(frag);
      } catch (err) {
        console.error("리뷰 불러오기 실패:", err);
        list.innerHTML = "<p>리뷰 로딩 실패</p>";
      }
    }

    loadReviews();
  </script>
</body>
</html>
