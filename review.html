<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¦¬ë·° - NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    // Firebase ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGvgFrFl1DWpkgqbwRo-TUwJa6quvohmA",
      authDomain: "nekorunail.firebaseapp.com",
      projectId: "nekorunail",
      storageBucket: "nekorunail.appspot.com",
      messagingSenderId: "571846382457",
      appId: "1:571846382457:web:6c0f66ca63163473fd15a8",
      measurementId: "G-MW8CBHGSLG"
    };

    let selectedRating = 0;
    let db, storage;

    document.addEventListener("DOMContentLoaded", async function() {
      console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
      
      try {
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        storage = getStorage(app);
        console.log('Firebase ì´ˆê¸°í™” ì„±ê³µ!');
        
        // ë³„ì  ì´ˆê¸°í™”
        initStars();
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners();
        
        // ê¸°ì¡´ ë¦¬ë·° ë¡œë“œ
        await loadReviews();
        
        console.log('ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ!');
        
      } catch (error) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        alert('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });

    function initStars() {
      const starRating = document.getElementById('star-rating');
      if (!starRating) {
        console.error('ë³„ì  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      starRating.innerHTML = `
        <span class="star" onclick="selectRating(1)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">â­</span>
        <span class="star" onclick="selectRating(2)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">â­</span>
        <span class="star" onclick="selectRating(3)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">â­</span>
        <span class="star" onclick="selectRating(4)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">â­</span>
        <span class="star" onclick="selectRating(5)" style="font-size: 2rem; cursor: pointer; opacity: 0.3; margin: 0 0.2rem;">â­</span>
      `;
      console.log('ë³„ì  ìƒì„± ì™„ë£Œ');
    }

    function setupEventListeners() {
      const form = document.getElementById("review-form");
      const imageInput = document.getElementById("review-image");
      
      if (form) {
        form.addEventListener("submit", handleSubmit);
        console.log('í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
      }
      
      if (imageInput) {
        imageInput.addEventListener("change", handleImagePreview);
        console.log('ì´ë¯¸ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
      }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë³„ì  ì„ íƒ
    window.selectRating = function(rating) {
      selectedRating = rating;
      document.getElementById('rating').value = rating;
      
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.style.opacity = index < rating ? '1' : '0.3';
      });
      
      const texts = ['ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”', 'â­ ë³„ë¡œì˜ˆìš”', 'â­â­ ê·¸ì € ê·¸ë˜ìš”', 'â­â­â­ ë³´í†µì´ì—ìš”', 'â­â­â­â­ ì¢‹ì•„ìš”', 'â­â­â­â­â­ ìµœê³ ì˜ˆìš”!'];
      document.querySelector('.rating-text').textContent = texts[rating];
      console.log('ë³„ì  ì„ íƒë¨:', rating);
    };

    function handleImagePreview(e) {
      const file = e.target.files[0];
      const preview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert("íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          e.target.value = '';
          return;
        }

        if (!file.type.startsWith('image/')) {
          alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          e.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          preview.style.display = 'block';
          document.querySelector('.image-upload-area').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      console.log('í¼ ì œì¶œ ì‹œì‘');
      
      const name = document.getElementById("reviewer").value.trim();
      const content = document.getElementById("review-content").value.trim();
      const rating = selectedRating;
      const imageInput = document.getElementById("review-image");
      const imageFile = imageInput ? imageInput.files[0] : null;
      
      console.log('ì…ë ¥ê°’ í™•ì¸:', { name, content, rating, hasImage: !!imageFile });
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!name) {
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      if (!content) {
        alert("í›„ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      if (!rating || rating < 1 || rating > 5) {
        alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const submitBtn = document.getElementById("submit-btn");
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.textContent = "ë“±ë¡ ì¤‘...";
        submitBtn.disabled = true;
        
        let imageUrl = null;

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìˆëŠ” ê²½ìš°)
        if (imageFile) {
          console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...');
          const imageRef = ref(storage, `reviews/${Date.now()}_${imageFile.name}`);
          await uploadBytes(imageRef, imageFile);
          imageUrl = await getDownloadURL(imageRef);
          console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:', imageUrl);
        }

        // ë¦¬ë·° ë°ì´í„° ì €ì¥
        console.log('Firestoreì— ì €ì¥ ì‹œì‘...');
        const docRef = await addDoc(collection(db, "reviews"), {
          name,
          content,
          rating,
          imageUrl,
          createdAt: serverTimestamp()
        });
        
        console.log('ë¦¬ë·° ì €ì¥ ì™„ë£Œ! ë¬¸ì„œ ID:', docRef.id);
        alert("í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ’–");
        
        // í¼ ì´ˆê¸°í™”
        resetForm();
        
        // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadReviews();

      } catch (error) {
        console.error("ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨:", error);
        alert("í›„ê¸° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    function resetForm() {
      document.getElementById("review-form").reset();
      selectedRating = 0;
      document.getElementById('rating').value = '';
      
      const stars = document.querySelectorAll('.star');
      stars.forEach(star => star.style.opacity = '0.3');
      document.querySelector('.rating-text').textContent = 'ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”';
      
      const preview = document.getElementById("image-preview");
      if (preview) preview.style.display = 'none';
      const uploadArea = document.querySelector('.image-upload-area');
      if (uploadArea) uploadArea.style.display = 'block';
    }

    async function loadReviews() {
      console.log('ë¦¬ë·° ë¡œë“œ ì‹œì‘...');
      
      try {
        const reviewsContainer = document.getElementById("reviews-container");
        if (!reviewsContainer) {
          console.log('ë¦¬ë·° ì»¨í…Œì´ë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        console.log('ê°€ì ¸ì˜¨ ë¦¬ë·° ìˆ˜:', snapshot.size);
        
        reviewsContainer.innerHTML = '';
        
        if (snapshot.empty) {
          reviewsContainer.innerHTML = `
            <div class="no-reviews">
              <p>ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              <p>ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”! âœ¨</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(function(doc) {
          const data = doc.data();
          const reviewBox = document.createElement("div");
          reviewBox.className = "review-box";
          
          const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
          const dateString = createdAt.toLocaleDateString('ko-KR');
          
          const rating = data.rating || 5;
          const starsDisplay = 'â­'.repeat(rating) + 'â˜†'.repeat(5 - rating);
          
          const imageHtml = data.imageUrl ? 
            `<div style="text-align: center; margin-top: 1rem;">
               <img src="${data.imageUrl}" alt="í›„ê¸° ì‚¬ì§„" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
             </div>` : '';
          
          reviewBox.innerHTML = `
            <div class="review-header">
              <strong class="review-author">ğŸ‘¤ ${data.name}</strong>
              <span class="review-date">ğŸ“… ${dateString}</span>
            </div>
            <div class="review-rating">${starsDisplay}</div>
            <div class="review-content">${data.content}</div>
            ${imageHtml}
          `;
          
          reviewsContainer.appendChild(reviewBox);
        });
        
        console.log('ë¦¬ë·° ë¡œë“œ ì™„ë£Œ!');
        
      } catch (error) {
        console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", error);
        const reviewsContainer = document.getElementById("reviews-container");
        if (reviewsContainer) {
          reviewsContainer.innerHTML = `
            <div class="error-message">
              <p>í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
              <p>ì˜¤ë¥˜: ${error.message}</p>
            </div>
          `;
        }
      }
    }

    window.removeImage = function() {
      document.getElementById("review-image").value = '';
      document.getElementById("image-preview").style.display = 'none';
      document.querySelector('.image-upload-area').style.display = 'block';
    };
  </script>
</head>
<body>
  <header class="hero">
    <nav>
        <ul>
          <li><a href="index.html">í™ˆ</a></li>
          <li><a href="gallery.html">ê°¤ëŸ¬ë¦¬</a></li>
          <li><a href="booking.html">ì˜ˆì•½</a></li>
          <li><a href="review.html">ë¦¬ë·° ë‚¨ê¸°ê¸°</a></li>
          <li><a href="come.html">ì°¾ì•„ì˜¤ì‹œëŠ” ê¸¸</a></li>
        </ul>
      </nav>
      <br><br>
    <h1>ë¦¬ë·°</h1>
    <p>ê³ ê°ë‹˜ì˜ ì†Œì¤‘í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”</p>
  </header>

  <section class="review-form-section">
    <div class="form-container">
      <h3>í›„ê¸° ì‘ì„±í•˜ê¸°</h3>
      <form id="review-form">
        <div class="form-group">
          <label for="reviewer">ì´ë¦„</label>
          <input type="text" id="reviewer" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required style="font-family: 'MaruBuri';"/>
        </div>
        
        <div class="form-group">
          <label for="rating">ë³„ì </label>
          <div class="star-rating" id="star-rating" style="display: flex; justify-content: center; margin: 1rem 0;">
            <!-- ë³„ì ì€ JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
          </div>
          <input type="hidden" id="rating" name="rating" required />
          <p class="rating-text" style="text-align: center;">ë³„ì„ í´ë¦­í•˜ì—¬ í‰ì ì„ ë§¤ê²¨ì£¼ì„¸ìš”</p>
        </div>
        
        <div class="form-group">
          <label for="review-content">í›„ê¸° ë‚´ìš©</label>
          <textarea id="review-content" placeholder="ë„¤ì¼ ì„œë¹„ìŠ¤ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” ğŸ’–" required style="font-family: 'MaruBuri'; height: 120px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="review-image">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒì‚¬í•­)</label>
          <div class="image-upload-area">
            <input type="file" id="review-image" accept="image/*" />
            <div class="upload-placeholder">
              <div class="upload-icon">ğŸ“·</div>
              <p>ë„¤ì¼ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
              <span class="upload-hint">JPG, PNG, GIF í˜•ì‹ (ìµœëŒ€ 5MB)</span>
            </div>
          </div>
          <div id="image-preview" style="display: none; text-align: center; margin-top: 1rem;">
            <img id="preview-img" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 200px; max-height: 150px; border-radius: 8px;" />
            <br>
            <button type="button" onclick="removeImage()" style="margin-top: 0.5rem; background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">ì‚¬ì§„ ì œê±°</button>
          </div>
        </div>
        
        <div style="text-align: center;">
          <button type="submit" id="submit-btn">
            í›„ê¸° ë“±ë¡í•˜ê¸°
          </button>
        </div>
      </form>
    </div>
  </section>

  <section class="reviews-display-section">
    <h3>ê³ ê°ë‹˜ë“¤ì˜ í›„ê¸°</h3>
    <div id="reviews-container">
      <div style="text-align: center; padding: 2rem;">
        <p>í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
  </section>

  <footer>
    <p>NEKORUNAIL âœ Instagram @NEKORUnail âœ 2025</p>
  </footer>
</body>
</html>