<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEKORUNAIL</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="hero">
    <h1>NEKORUNAIL</h1>
    <p>부산 부산진구 가야대로750번길 4, 3층</p>
    <nav>
      <ul>
        <li><a href="index.html">홈</a></li>
        <li><a href="gallery.html">갤러리</a></li>
        <li><a href="booking.html">예약</a></li>
        <li><a href="review.html">리뷰</a></li>
        <li><a href="come.html">오시는 길</a></li>
      </ul>
    </nav>
  </header>

  <section class="intro-section">
    <div class="intro-content">
      <h2><a href="admin.html">✨NEKORUNAIL✨</a></h2>
      <h3>네일 디자인</h3>
    </div>
  </section>

  <section id="gallery">
    <div id="gallery-slider" class="gallery-slider">
      <div class="loading-slider">
        <div class="loading-spinner"></div>
        <p>디자인을 불러오는 중...</p>
      </div>
    </div>
  </section>

  <section id="customer-reviews" class="reviews-section">
    <h2>고객 후기</h2>
    <p class="section-subtitle">실제 고객님들이 남겨주신 소중한 후기입니다</p>
    <div id="reviews-container" class="reviews-preview-grid">
      <div class="review-loading">
        <div class="loading-spinner"></div>
        <p>후기를 불러오는 중...</p>
      </div>
    </div>
    <div class="reviews-actions">
      <a href="review.html" class="view-more-btn">모든 후기 보기</a>
    </div>
  </section>

  <footer>
    <p>NEKORUNAIL ⎜ Instagram @nekorunail ⎜ 2025</p>
  </footer>

  <script type="module">
    console.log('🔥 Firebase 연결 시작...');

    let db = null;
    let connectionRetryCount = 0;
    const MAX_RETRIES = 3;

    async function initializeFirebase() {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js");
        const { getFirestore, connectFirestoreEmulator, collection, getDocs, query, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");

        const firebaseConfig = {
          apiKey: "AIzaSyBGvgFrFl1DWpkgqbwRo-TUwJa6quvohmA",
          authDomain: "nekorunail.firebaseapp.com",
          projectId: "nekorunail",
          storageBucket: "nekorunail.appspot.com",
          messagingSenderId: "571846382457",
          appId: "1:571846382457:web:6c0f66ca63163473fd15a8"
        };

        const app = initializeApp(firebaseConfig);
        
        try {
          db = getFirestore(app);
          console.log('✅ Firebase 초기화 성공');
          return { collection, getDocs, query, orderBy, limit };
        } catch (firestoreError) {
          console.error('Firestore 초기화 실패:', firestoreError);
          throw firestoreError;
        }

      } catch (error) {
        console.error('Firebase 초기화 실패:', error);
        connectionRetryCount++;
        
        if (connectionRetryCount < MAX_RETRIES) {
          console.log(`재시도 중... (${connectionRetryCount}/${MAX_RETRIES})`);
          await new Promise(resolve => setTimeout(resolve, 2000));
          return initializeFirebase();
        }
        
        throw error;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadContent();
      } catch (error) {
        console.error('컨텐츠 로드 실패:', error);
        showOfflineContent();
      }
    });

    async function loadContent() {
      try {
        const firebaseModules = await initializeFirebase();
        await Promise.all([
          loadGallerySlider(firebaseModules),
          loadReviewsPreview(firebaseModules)
        ]);
      } catch (error) {
        console.error('Firebase 컨텐츠 로드 실패:', error);
        showOfflineContent();
      }
    }

    async function loadGallerySlider(firebaseModules) {
      const slider = document.getElementById('gallery-slider');
      
      try {
        if (!db || !firebaseModules) {
          throw new Error('Firebase not initialized');
        }

        const { collection, getDocs, query, orderBy, limit } = firebaseModules;
        const q = query(collection(db, "gallery"), orderBy("createdAt", "desc"), limit(6));
        const snapshot = await getDocs(q);
        
        slider.innerHTML = '';
        
        if (snapshot.empty) {
          slider.innerHTML = `
            <div class="no-gallery">
              <p>갤러리가 비어있습니다.</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement('div');
          card.className = 'gallery-card';
          
          card.innerHTML = `
            <img src="${data.imageUrl}" alt="${data.caption || 'nail art'}" loading="lazy">
            <div class="info">
              <h4>${data.caption || '네일 디자인'}</h4>
            </div>
          `;
          
          card.addEventListener('click', () => {
            openModal(data.imageUrl, data.caption || '네일 디자인');
          });
          
          slider.appendChild(card);
        });
        
        console.log('✅ 갤러리 로드 성공');
        
      } catch (error) {
        console.error('갤러리 로드 실패:', error);
        slider.innerHTML = `
          <div class="error-gallery">
            <p>갤러리를 불러올 수 없습니다.</p>
            <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: hotpink; color: white; border: none; border-radius: 5px; cursor: pointer;">새로고침</button>
          </div>
        `;
      }
    }

    async function loadReviewsPreview(firebaseModules) {
      const container = document.getElementById('reviews-container');
      
      try {
        if (!db || !firebaseModules) {
          throw new Error('Firebase not initialized');
        }

        const { collection, getDocs, query, orderBy, limit } = firebaseModules;
        const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"), limit(3));
        const snapshot = await getDocs(q);
        
        container.innerHTML = '';
        
        if (snapshot.empty) {
          container.innerHTML = `
            <div class="no-reviews">
              <p>아직 등록된 후기가 없습니다.</p>
              <p>첫 번째 후기를 남겨보세요! ✨</p>
            </div>
          `;
          return;
        }
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const reviewCard = document.createElement('div');
          reviewCard.className = 'review-preview';
          
          const createdAt = data.createdAt?.toDate() || new Date();
          const dateString = createdAt.toLocaleDateString('ko-KR');
          const stars = '⭐'.repeat(data.rating || 5);
          
          reviewCard.innerHTML = `
            <div class="stars">${stars}</div>
            <p class="review-text">"${data.content}"</p>
            <cite class="review-author">- ${data.name} (${dateString})</cite>
          `;
          
          container.appendChild(reviewCard);
        });
        
        console.log('✅ 후기 로드 성공');
        
      } catch (error) {
        console.error('후기 로드 실패:', error);
        container.innerHTML = `
          <div class="error-message">
            <p>후기를 불러올 수 없습니다.</p>
            <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: hotpink; color: white; border: none; border-radius: 5px; cursor: pointer;">새로고침</button>
          </div>
        `;
      }
    }

    function showOfflineContent() {
      console.log('📱 오프라인 모드로 전환');
      
      const slider = document.getElementById('gallery-slider');
      slider.innerHTML = `
        <div class="offline-content">
          <h3>🌐 연결 문제</h3>
          <p>네트워크 연결을 확인해주세요</p>
          <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: hotpink; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">다시 시도</button>
        </div>
      `;
      
      const reviewsContainer = document.getElementById('reviews-container');
      reviewsContainer.innerHTML = `
        <div class="offline-content">
          <p>네트워크 연결 후 새로고침해주세요</p>
        </div>
      `;
    }

    function openModal(imageUrl, caption) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 10000; cursor: pointer;
      `;
      
      modal.innerHTML = `
        <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 10px; overflow: hidden;">
          <span style="position: absolute; top: 10px; right: 15px; font-size: 2rem; color: white; cursor: pointer; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</span>
          <img src="${imageUrl}" style="max-width: 100%; max-height: 80vh; display: block;" />
          <div style="padding: 1rem; text-align: center; font-weight: 600; color: #333;">${caption}</div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('span').onclick = () => modal.remove();
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modal.remove(); });
    }

    const style = document.createElement('style');
    style.textContent = `
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid hotpink;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .intro-section {
        padding: 2rem 2rem 0;
        text-align: center;
      }
      
      .intro-content h2 {
        font-size: 2.5rem;
        color: #333;
        margin-bottom: 0.5rem;
      }
      
      .intro-content h3 {
        font-size: 1.3rem;
        color: #666;
        margin-bottom: 1rem;
        font-weight: 400;
      }
      
      .loading-slider, .no-gallery, .error-gallery, .offline-content {
        text-align: center;
        padding: 3rem 2rem;
        color: #666;
      }
      
      .offline-content h3 {
        color: #333;
        margin-bottom: 1rem;
      }
      
      .review-preview {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        text-align: center;
      }
      
      .review-preview .stars {
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }
      
      .review-text {
        font-style: italic;
        color: #333;
        margin-bottom: 1rem;
        line-height: 1.5;
      }
      
      .review-author {
        color: #666;
        font-size: 0.9rem;
      }
      
      .no-reviews, .error-message, .offline-content {
        text-align: center;
        padding: 2rem;
        color: #666;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        grid-column: 1 / -1;
      }
      
      @media (max-width: 768px) {
        .intro-content h2 {
          font-size: 2rem;
        }
        
        .intro-content h3 {
          font-size: 1.1rem;
        }
      }
    `;
    document.head.appendChild(style);

    console.log('📱 페이지 스크립트 로드 완료');
  </script>
</body>
</html>